local Z,G,S,V,P,U;S,G,P,V,U={},game,pairs,Vector3.new,CFrame.new;local function dec(t)local r,c,b={},string.char,bit32.bxor;for i=1,#t do r[i]=c(b(t[i],17))end;return table.concat(r)end;local srv={dec{114,117,110,115,101,114,118,105,99,101},dec{99,111,108,108,101,99,116,105,111,110,115,01,114,118,105,99,101},dec{119,111,114,107,115,112,97,99,101},dec{115,116,97,116,115},dec{108,105,103,104,116,105,110,103},dec{99,111,110,116,101,110,116,112,114,111,118,105,100,101,114},dec{117,115,101,114,103,97,109,101,115,101,116,116,105,110,103,115},dec{112,104,121,115,105,99,115,101,114,118,105,99,101},dec{112,108,97,121,101,114,115}};local s1,s2,s3,s4,s5,s6,s7,s8,s9=G:GetService(srv[1]),G:GetService(srv[2]),G:GetService(srv[3]),G:GetService(srv[4]),G:GetService(srv[5]),G:GetService(srv[6]),UserSettings():GetService(srv[7]),G:GetService(srv[8]),G:GetService(srv[9]);local cam,clk,ins,rem,cln,flr,inf,ex,mn,mx,clmp=s3.CurrentCamera,os.clock,table.insert,table.remove,table.clone,math.floor,math.huge,math.exp,math.min,math.max,math.clamp;local ip,pc,sp,wt,dl,cr,rs=ipairs,pcall,task.spawn,task.wait,task.delay,coroutine.create,coroutine.resume;local l_gfp=cam.GetFrustumPlanes;Z.U={};function Z.U.iV(p,bS)local f,bP=l_gfp(cam),p.Position;for i=1,6 do local pl=f[i];local d=pl.Normal:Dot(bP)-pl.Offset;local r=bS.X*math.abs(pl.Normal.X)+bS.Y*math.abs(pl.Normal.Y)+bS.Z*math.abs(pl.Normal.Z);if d<-r then return false end end;return true end;Z._M1={PROFS={[1]={f=120,p=60,m=2000},[2]={f=60,p=55,m=1200},[3]={f=45,p=40,m=800},[4]={f=30,p=25,m=400}},aggr={r=2,p=2,e=2,d=2,c=2,res=2},_avgFps=60,_prevFps=60,_lastCheck=0,_isCalibrated=false,_state="Normal",_cdStart=0,_potato=false,CD_DUR=6,REC_DUR=4,REC_FPS=42,EMG_FPS=38};function Z._M1:f1(s)if self._state==s then return end;self._state=s;if s=="Emergency"then for k,_ in P(self.aggr)do self.aggr[k]=5 end;Z._M11:f1(1);Z._M8:f4(0.5,0.3)elseif s=="Cooldown"then self._cdStart=clk()elseif s=="Normal"then Z._M8:f4(1,0.5);local sA,e,d=cln(self.aggr),0,self.REC_DUR;sp(function()while e<d and self._state=="Normal"do local a=e/d;for k,v in P(sA)do self.aggr[k]=v+(2-v)*a end;e+=s1.Heartbeat:Wait()end;if self._state=="Normal"and not self._potato then Z._M11:f2()end end)end end;function Z._M1:f2(dt)local e=ex(-dt*3);self._avgFps=e*self._avgFps+(1-e)*(1/dt)if not self._isCalibrated then return end;local s,af=self._state,self._avgFps;if s=="Normal"then if af<self.EMG_FPS or af<self._prevFps*0.65 then self:f1("Emergency")end elseif s=="Emergency"then if af>self.REC_FPS then self:f1("Cooldown")end elseif s=="Cooldown"then if af<self.EMG_FPS then self:f1("Emergency")elseif clk()-self._cdStart>self.CD_DUR then self:f1("Normal")end end;self._prevFps=af;if s~="Normal"then return end;local n=clk()if n-self._lastCheck<0.5 then return end;self._lastCheck=n;local pr,ag=self.PROFS,self.aggr;local p=pr[4];if af>pr[2].f then p=pr[1]elseif af>pr[3].f then p=pr[2]else p=pr[3]end;local rs,ps,ms=af/p.f,s3:GetRealPhysicsFPS()/p.p,p.m/s4.Total.Value;local a=0.632;local nr,np,ne,nd,nc,nres=rs<0.9 and(rs<0.7 and 3 or 2)or 1,ps<0.9 and(ps<0.7 and 4 or 3)or 1,(rs<1 or ms<1)and(rs<0.8 or ms<0.8 and 4 or 3)or 1,rs<0.9 and(rs<0.75 and 4 or 3)or 1,p==pr[4]and 3 or p==pr[3]and 2 or 1,ms<0.8 and 3 or 1;ag.r=ag.r+(nr-ag.r)*a;ag.p=ag.p+(np-ag.p)*a;ag.e=ag.e+(ne-ag.e)*a;ag.d=ag.d+(nd-ag.d)*a;ag.c=ag.c+(nc-ag.c)*a;ag.res=ag.res+(nres-ag.res)*a;if ag.c>=3 and not self._potato then self._potato=true;Z._M11:f1(1)elseif ag.c<2 and self._potato and s=="Normal"then self._potato=false;Z._M11:f2()end end;Z._M2={SIM_THRESH=15,PART_THRESH=50,FX_THRESH=5,_scanIndex=1,_scanChildren=nil,SCAN_BATCH_SIZE=10};function Z._M2:f1()local tags={"ManagedRender","ManagedEffect","Clutter"};local function pr(m)local pC,eC=0,0;for _,d in ip(m:GetDescendants())do if d:IsA("BasePart")then pC+=1 elseif d:IsA("ParticleEmitter")or d:IsA("Light")then eC+=1 end end;if pC>self.PART_THRESH and not s2:HasTag(m,tags[1])then s2:AddTag(m,tags[1])end;if eC>self.FX_THRESH and not s2:HasTag(m,tags[2])then s2:AddTag(m,tags[2])end end;if not self._scanChildren then self._scanChildren=s3:GetChildren();self._scanIndex=1 end;local processedCount=0;while self._scanIndex<=#self._scanChildren and processedCount<self.SCAN_BATCH_SIZE do local i=self._scanChildren[self._scanIndex];if i:IsA("Model")and i.PrimaryPart then pr(i)elseif i:IsA("MeshPart")then local k=i.MeshId;if k~=""then Z._M2.s=Z._M2.s or {};Z._M2.s[k]=Z._M2.s[k]or{c=0,i={}};Z._M2.s[k].c+=1;ins(Z._M2.s[k].i,i)end end;self._scanIndex+=1;processedCount+=1 end;if self._scanIndex>#self._scanChildren then local s=Z._M2.s;if s then for _,d in P(s)do if d.c>self.SIM_THRESH then for _,o in ip(d.i)do if not s2:HasTag(o,tags[3])then s2:AddTag(o,tags[3])end end end end end;self._scanChildren=nil;self._scanIndex=1 end end;Z._M3={};function Z._M3:f1()wt(5);local d=5;local s,st={},clk();while clk()-st<d do ins(s,1/s1.Heartbeat:Wait())end;local sm=0;for _,f in ip(s)do sm+=f end;local af=sm/#s;local o=Z._M1;o.PROFS[1].f=mx(60,af*0.9);o.PROFS[2].f=mx(45,af*0.7);o.PROFS[3].f=mx(30,af*0.5);o._isCalibrated=true end;Z._M4={_tasks={}};function Z._M4:f1(t)local c=cr(function()while true do pc(t.fn,t.args or{})local a=Z._M1.aggr[t.cat]or 1;wt(t.int*a)end end);ins(self._tasks,c)end;function Z._M4:f2()for _,c in ip(self._tasks)do rs(c)end end;Z._M5={GRID_SIZE=250,_grid={},_tracked=setmetatable({},{__mode="k"})};function Z._M5:f1(o,d)if not(o and o:IsA("BasePart"))then return end;local s=self.GRID_SIZE;local p=o.Position;local k=flr(p.X/s).." "..flr(p.Y/s).." "..flr(p.Z/s);self._grid[k]=self._grid[k]or{};ins(self._grid[k],o);self._tracked[o]={c=k,d=d}end;function Z._M5:f2(p,r)local res,s={},self.GRID_SIZE;local cR=flr(r/s)+1;local cx,cy,cz=flr(p.X/s),flr(p.Y/s),flr(p.Z/s);for i=cx-cR,cx+cR do for j=cy-cR,cy+cR do for k=cz-cR,cz+cR do local c=self._grid[i.." "..j.." "..k];if c then for _,o in ip(c)do ins(res,o)end end end end end;return res end;Z._M6={DIST_SQR={[1]={14400,90000,360000},[2]={6400,40000,202500},[3]={2500,22500,90000},[4]={1600,14400,62500},[5]={900,6400,22500}},_culled={},_rQ={_h=1,_t=1}};function Z._M6:f1(m)if not m.PrimaryPart then return end;local p={};local bS=V();for _,d in ip(m:GetDescendants())do if d:IsA("BasePart")then ins(p,d);bS=bS+d.Size end end;local bSz=m:GetBoundingBox();Z._M5:f1(m.PrimaryPart,{LOD={p=p,m=m,lf=-1,lt=0,isC=false,bS=bSz.Size,fT=1}})end;function Z._M6:f2(cf)local a=flr(Z._M1.aggr.r+0.5);local l,cP=clmp(a,1,5),cf.Position;local lSqr=self.DIST_SQR[l];local nby=Z._M5:f2(cP,800);for _,pP in ip(nby)do local t=Z._M5._tracked[pP];if not(pP and pP.Parent and t and t.d.LOD)then continue end;local ld=t.d.LOD;if ld.isC then continue end;local dSqr=(pP.Position-cP).MagnitudeSqr;if not Z.U.iV(pP,ld.bS)and dSqr>lSqr[2]then ld.isC=true;ins(self._culled,{o=ld.m,p=ld.m.Parent,d=ld});ld.m.Parent=nil;if ld.m.PrimaryPart then ld.m.PrimaryPart:SetNetworkOwner(nil)end;Z._M12:setGroup(ld.m,true)else local nT,nF;if dSqr<lSqr[1]then nT,nF=0,0
elseif dSqr<lSqr[2]then nT,nF=0.75,1
else nT,nF=1,2 end;
if ld.lt~=nT then for _,part in ip(ld.p)do part.LocalTransparencyModifier=nT end;ld.lt=nT end;if ld.lf~=nF then local rf=Enum.RenderFidelity.FromValue(nF);for _,part in ip(ld.p)do part.RenderFidelity=rf end;ld.lf=nF end end end end;function Z._M6:f3(cf)local a=flr(Z._M1.aggr.r+0.5);local l=clmp(a,1,5);local dSqr=self.DIST_SQR[l][2]*1.2;for i=#self._culled,1,-1 do local cE=self._culled[i];local pP=cE.o.PrimaryPart;if not pP then rem(self._culled,i);continue end;if Z.U.iV(pP,cE.d.bS)and(pP.Position-cf.Position).MagnitudeSqr<dSqr then local q=self._rQ;q[q._t]=cE;q._t+=1;rem(self._culled,i)end end end;function Z._M6:f4()local q=self._rQ;local currentMaxProcess=2;local processedThisFrame=0;while q._h<q._t and processedThisFrame<currentMaxProcess do local r=q[q._h];q[q._h]=nil;q._h+=1;if r and r.o and r.p then r.o.Parent=r.p;if r.o.PrimaryPart then r.o.PrimaryPart:SetNetworkOwner(s9.LocalPlayer)end;Z._M12:setGroup(r.o,false);if r.d then r.d.isC=false;local d=r.d;sp(function()local s,e=1,d.lt or 0;local t=0.3;local st=clk();while clk()-st<t do local a=(clk()-st)/t;for _,pt in ip(d.p)do pt.LocalTransparencyModifier=s+(e-s)*a end;wt()end;for _,pt in ip(d.p)do pt.LocalTransparencyModifier=e end end)end;end;processedThisFrame+=1;end;if q._h>10 then q._h=1;q._t=1 end end;Z._M7={DIST_SQR={[1]=inf,[2]=62500,[3]=22500,[4]=6400,[5]=1600},SLEEP_VEL=0.5};function Z._M7:f1(m)if not m.PrimaryPart then return end;local p={};for _,d in ip(m:GetDescendants())do if d:IsA("BasePart")and not d.Anchored then ins(p,d)end end;if #p>0 then Z._M5:f1(m.PrimaryPart,{Physics={p=p}})end end;function Z._M7:f2(cP)local a=flr(Z._M1.aggr.p+0.5);local l=clmp(a,1,5);local dSqr=self.DIST_SQR[l];local nby=Z._M5:f2(cP,500);for _,pP in ip(nby)do local t=Z._M5._tracked[pP];if not(pP and pP.Parent and t and t.d.Physics)then continue end;local sA=(pP.Position-cP).MagnitudeSqr>dSqr or pP.AssemblyLinearVelocity.Magnitude<self.SLEEP_VEL;for _,p in ip(t.d.Physics.p)do if p and p.Anchored~=sA then p.Anchored=sA;if sA then p:SetNetworkOwner(nil);Z._M12:setGroup(p,true)else p:SetNetworkOwner(s9.LocalPlayer);Z._M12:setGroup(p,false)end end end end end;Z._M8={DIST_CULL={[1]=500,[2]=300,[3]=150,[4]=80,[5]=0},_effects={}};function Z._M8:f1(i)local aP=i:IsA("BasePart")and i or i:FindFirstAncestorWhichIsA("Model")and i:FindFirstAncestorWhichIsA("Model").PrimaryPart;if not aP then return end;local function pE(e)local d={e=e,a=aP,o={},c={}};if e:IsA("ParticleEmitter")then d.o.Rate=e.Rate;d.c.Rate=e.Rate elseif e:IsA("Light")then d.o.Brightness=e.Brightness;d.c.Brightness=e.Brightness elseif e:IsA("Beam")then d.o.Width0=e.Width0;d.o.Width1=e.Width1;d.c.Width0=e.Width0;d.c.Width1=e.Width1 elseif e:IsA("Trail")then d.o.Lifetime=e.Lifetime;d.c.Lifetime=e.Lifetime end;ins(self._effects,d)end;if i:IsA("ParticleEmitter")or i:IsA("Beam")or i:IsA("Trail")or i:IsA("Light")then pE(i)else for _,d in ip(i:GetDescendants())do if d:IsA("ParticleEmitter")or d:IsA("Beam")or d:IsA("Trail")or d:IsA("Light")then pE(d)end end end end;function Z._M8:f3(cf)local a=flr(Z._M1.aggr.e+0.5);local l=clmp(a,1,5);local cD,cP=self.DIST_CULL[l],cf.Position;for _,d in ip(self._effects)do local e,aP=d.e,d.a;if not(e and e.Parent and aP and aP.Parent)then continue end;local sE=Z.U.iV(aP,aP.Size)and(aP.Position-cP).Magnitude<cD;if e.Enabled~=sE then e.Enabled=sE end end end;function Z._M8:f4(m,t)sp(function()for _,d in ip(self._effects)do local e=d.e;if e and e.Parent and d.o then local st=clk();sp(function() while clk()-st<t do local a=(clk()-st)/t;if e:IsA("ParticleEmitter")then d.c.Rate=d.c.Rate+(d.o.Rate*m-d.c.Rate)*a;e.Rate=d.c.Rate elseif e:IsA("Light")then d.c.Brightness=d.c.Brightness+(d.o.Brightness*m-d.c.Brightness)*a;e.Brightness=d.c.Brightness end;wt()end end)end end end)end;Z._M9={CULL_PCNT={[1]=0,[2]=0.25,[3]=0.5,[4]=0.75,[5]=0.9},DIST_START=150,_culled={},_clutter={}};function Z._M9:f1(i)local pP=i:IsA("Model")and i.PrimaryPart or(i:IsA("BasePart")and i);if pP then ins(self._clutter,{i=i,pP=pP,isC=false})end end;function Z._M9:f2(cP)local a=flr(Z._M1.aggr.d+0.5);local l=clmp(a,1,5);local cPcnt=self.CULL_PCNT[l];if cPcnt==0 then self:f4()return end;local pTC={};for _,cD in ip(self._clutter)do if not cD.isC and(cD.pP.Position-cP).Magnitude>self.DIST_START then ins(pTC,cD)end end;local currentMaxProcess=2;local processedCount=0;for i=1,flr(#pTC*cPcnt)do if processedCount>=currentMaxProcess then break end;local cD=pTC[i];if not cD.isC then cD.isC=true;ins(self._culled,{o=cD.i,p=cD.i.Parent,d=cD});cD.i.Parent=nil;if cD.pP then cD.pP:SetNetworkOwner(nil)end;Z._M12:setGroup(cD.i,true)end;processedCount+=1;end;function Z._M9:f3(cP)for i=#self._culled,1,-1 do local e=self._culled[i];if(e.d.pP.Position-cP).Magnitude<self.DIST_START*0.9 then e.d.isC=false;e.o.Parent=e.p;if e.d.pP then e.d.pP:SetNetworkOwner(s9.LocalPlayer)end;Z._M12:setGroup(e.o,false);rem(self._culled,i)end end end;function Z._M9:f4()for i=#self._culled,1,-1 do local e=self._culled[i];e.d.isC=false;e.o.Parent=e.p;if e.d.pP then e.d.pP:SetNetworkOwner(s9.LocalPlayer)end;Z._M12:setGroup(e.o,false);rem(self._culled,i)end end;Z._M10={_assets={},UNLOAD_TIME=150,UNLOAD_BATCH_SIZE=10,_keysToUnload={},_currentUnloadBatchIndex=1,_lastCheckedKey=nil};function Z._M10:f1(id)if type(id)=="string"and id:match("rbx")then self._assets[id]=clk()end end;function Z._M10:f2()local n=clk();local a=Z._M1.aggr.res;local checkedCount=0;local currentKey=self._lastCheckedKey;local newKeysFound=false;while checkedCount<self.UNLOAD_BATCH_SIZE do local id,lU=next(self._assets,currentKey);if not id then self._lastCheckedKey=nil;break end;currentKey=id;if n-lU>self.UNLOAD_TIME*a then ins(self._keysToUnload,id);newKeysFound=true end;checkedCount+=1 end;self._lastCheckedKey=currentKey;local unloadedCount=0;while self._currentUnloadBatchIndex<=#self._keysToUnload and unloadedCount<self.UNLOAD_BATCH_SIZE do local idToUnload=self._keysToUnload[self._currentUnloadBatchIndex];s6:UnloadAssets({idToUnload});self._assets[idToUnload]=nil;self._keysToUnload[self._currentUnloadBatchIndex]=nil;self._currentUnloadBatchIndex+=1;unloadedCount+=1 end;if self._currentUnloadBatchIndex>#self._keysToUnload then self._currentUnloadBatchIndex=1;local newKeysToUnload={};for _,v in ip(self._keysToUnload)do if v~=nil then ins(newKeysToUnload,v)end end;self._keysToUnload=newKeysToUnload end end;Z._M11={};function Z._M11:f1(l)s7.SavedQualityLevel=Enum.SavedQualitySetting["QualityLevel"..l];s5.Technology=0;s5.Shadows=false end;function Z._M11:f2()s7.SavedQualityLevel=Enum.SavedQualitySetting.Automatic;s5.Technology=2;s5.Shadows=true end;Z._M12={CULLED_GROUP_NAME="CulledParts",_initialized=false};function Z._M12:init()if self._initialized then return end;local success,err=pc(function()s8:CreateCollisionGroup(self.CULLED_GROUP_NAME)end);if not success and not string.find(err,"already exists")then warn("Failed to create collision group:",err)return end;s8:SetCollisionGroupCollidable(self.CULLED_GROUP_NAME,self.CULLED_GROUP_NAME,false);s8:SetCollisionGroupCollidable("Default",self.CULLED_GROUP_NAME,false);self._initialized=true end;function Z._M12:setGroup(instance,isCulled)if not self._initialized then self:init()end;if instance:IsA("BasePart")then instance.CollisionGroup=isCulled and self.CULLED_GROUP_NAME or "Default"elseif instance:IsA("Model")then for _,part in ip(instance:GetDescendants())do if part:IsA("BasePart")then part.CollisionGroup=isCulled and self.CULLED_GROUP_NAME or "Default"end end end end;Z._M13={_trackedScripts={},_checkIndex=1,CHECK_BATCH_SIZE=2,DIST_THRESHOLD=200};function Z._M13:f1(instance)if not instance then return end;if s2:HasTag(instance,"ManagedScriptActivity")then for _,script in ip(instance:GetDescendants())do if script:IsA("Script")or script:IsA("LocalScript")then ins(self._trackedScripts,script)end end end end;function Z._M13:f2(cP)local processedCount=0;while self._checkIndex<=#self._trackedScripts and processedCount<self.CHECK_BATCH_SIZE do local script=self._trackedScripts[self._checkIndex];if not script or not script.Parent then rem(self._trackedScripts,self._checkIndex);goto continue end;local targetPart=script.Parent:IsA("BasePart")and script.Parent or script.Parent:FindFirstAncestorWhichIsA("BasePart");if targetPart then local distSqr=(targetPart.Position-cP).MagnitudeSqr;local shouldBeDisabled=distSqr>self.DIST_THRESHOLD*self.DIST_THRESHOLD;if script.Disabled~=shouldBeDisabled then script.Disabled=shouldBeDisabled end end;self._checkIndex+=1;processedCount+=1;::continue:: end;if self._checkIndex>#self._trackedScripts then self._checkIndex=1 end end;Z._newInstancesQueue={};function Z:processNewInstancesQueue()local batchSize=5;local processedCount=0;while #self._newInstancesQueue > 0 and processedCount < batchSize do local i=rem(self._newInstancesQueue,1);if not i then continue end;if s2:HasTag(i,"ManagedRender")then Z._M6:f1(i)end;if s2:HasTag(i,"ManagedPhysics")then Z._M7:f1(i)end;if s2:HasTag(i,"ManagedEffect")then Z._M8:f1(i)end;if s2:HasTag(i,"Clutter")then Z._M9:f1(i)end;Z._M13:f1(i);processedCount+=1 end end;function Z:Activate()Z._M12:init();sp(self._M3.f1,self);sp(self._M2.f1,self);local function pr(i)if not i then return end;ins(Z._newInstancesQueue,i)end;local tags={"ManagedRender","ManagedPhysics","ManagedEffect","Clutter","ManagedScriptActivity"};for _,t in ip(tags)do for _,i in ip(s2:GetTagged(t))do pr(i)end;s2:GetInstanceAddedSignal(t):Connect(pr)end;s3.DescendantAdded:Connect(function(d)if d:IsA("Sound")then Z._M10:f1(d.SoundId)elseif d:IsA("ImageLabel")or d:IsA("ImageButton")or d:IsA("Texture")then Z._M10:f1(d.Image)end end);self._M4:f1({fn=function()Z._M1:f2(s1.Heartbeat:Wait())end,int=0,cat="c"});local cf;self._M4:f1({fn=function()cf=cam.CFrame;Z._M6:f2(cf);Z._M7:f2(cf.Position);Z._M8:f3(cf);Z._M9:f2(cf.Position);Z._M13:f2(cf.Position)end,int=0.12,cat="c"});self._M4:f1({fn=function()cf=cam.CFrame;Z._M6:f3(cf);Z._M9:f3(cf.Position);Z._M6:f4()end,int=0.1,cat="r"});self._M4:f1({fn=function()Z._M10:f2()end,int=25,cat="res"});Z._M4:f1({fn=function()Z:processNewInstancesQueue()end,int=0.15,cat="init"});self._M4:f2()end;Z:Activate()
