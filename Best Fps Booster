local Z,G,S,V,P,U;S,G,P,Vector3.new,CFrame.new;local function dec(t)local r,c,b={},string.char,bit32.bxor;for i=1,#t do r[i]=c(b(t[i],17))end;return table.concat(r)end;local srv={dec{114,117,100,105,108,105,108,111},dec{114,117,110,115,101,114,118,105,99,101},dec{99,111,108,108,101,99,116,105,111,110,115,01,114,118,105,99,101},dec{119,111,114,114,115,112,97,99,101},dec{115,116,97,116,115},dec{108,111,99,97,108,112,108,97,121,101,114},dec{108,112,108,97,121,101,114,115},dec{104,116,116,112,115,101,114,118,105,99,101}};local R,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10=G:GetService(srv[1]),G:GetService(srv[2]),G:GetService(srv[3]),G:GetService(srv[4]),G:GetService(srv[5]),UserSettings():GetService(srv[6]),G:GetService(srv[7]),G:GetService(srv[8]),G:GetService(srv[9]),G:GetService(srv[10]),G:GetService(srv[11]);local cam,clk,ins,rem,cln,flr,inf,ex,mn,mx,clmp=s3.CurrentCamera,os.clock,table.insert,table.remove,table.clone,math.floor,math.huge,math.exp,math.min,math.max,math.clamp;local ip,pc,sp,wt,dl,cr,rs=ipairs,pcall,task.spawn,task.wait,task.delay,coroutine.create,coroutine.resume;local l_gfp=cam.GetFrustumPlanes;Z._isReady=false;Z.U={};function Z.U.iV(p,bS)local f,bP=l_gfp(cam),p.Position;for i=1,6 do local pl=f[i];local d=pl.Normal:Dot(bP)-pl.Offset;local r=bS.X*math.abs(pl.Normal.X)+bS.Y*math.abs(pl.Normal.Y)+bS.Z*math.abs(pl.Normal.Z);if d<-r then return false end end;return true end;Z._M1={PROFS={[1]={f=90,p=60,m=2000},[2]={55,50,1200},[3]={40,35,1000},[4]={30,20,600}},aggr={r=2,p=2,e=2,d=2,c=2,v=2,init=2},_avgFps=60,_prevFps=60,_lastCheck=0,_isCalibrated=true,_state="Normal",_cdStart=0,BASE_CD_DUR=6,BASE_REC_DUR=6,REC_FPS=60,EMG_FPS=45,_detectedMode="Mode 5 (Normal Operation)"};function Z._M1:f1(s)if self._state==s then return end;self._state=s;if s=="Emergency"then for k,_ in P(self.aggr)do self.aggr[k]=5 end;self._detectedMode="Mode 1 (Intense Events)";elseif s=="Cooldown"then self._cdStart=clk();self._detectedMode="Mode 2 (Unstable Performance)";elseif s=="Normal"then local sA,e,d=cln(self.aggr),0,mn(self.BASE_REC_DUR * 2, mx(1, flr(self.BASE_REC_DUR * (1 + (self.aggr.c - 1) / 4))));sp(function()while e<d and self._state=="Normal"do local a=e/d;for k,v in P(sA)do self.aggr[k]=v+(2-v)*a end;e+=s1.Heartbeat:Wait()end;end);self._detectedMode="Mode 5 (Normal Operation)";end end;function Z._M1:f2(dt)local e=ex(-dt*3);self._avgFps=e*self._avgFps+(1-e)*(1/dt)if not self._isCalibrated then return end;local s,af=self._state,self._avgFps;if s=="Normal"then if af<self.EMG_FPS and clk()-self._lastCheck>2 or af<self._prevFps*0.75 and clk()-self._lastCheck>1 then self:f1("Emergency")end elseif s=="Emergency"then if af>self.REC_FPS and clk()-self._lastCheck>3 then self:f1("Cooldown")end elseif s=="Cooldown"then if af<self.EMG_FPS and clk()-self._lastCheck>2 then self:f1("Emergency")elseif clk()-self._cdStart>mn(self.BASE_CD_DUR * 2, mx(1, flr(self.BASE_CD_DUR * (1 + (self.aggr.c - 1) / 4)))) and clk()-self._lastCheck>2 then self:f1("Normal")end end;if #Z._newInstancesQueue > 15 and af<self.EMG_FPS+5 and clk()-self._lastCheck>2 then self:f1("Emergency")end;self._prevFps=af;if s~="Normal"or clk()-self._lastCheck<0.5 then return end;self._lastCheck=clk();local pr,ag=self.PROFS,self.aggr;local p=pr[4];if af>pr[2][1]then p=pr[1]elseif af>pr[3][1]then p=pr[2]else p=pr[3]end;local rs,ps,ms=af/p[1],s8.GetPhysicsFPS()/p[2],p[3]/s4.Total.Value;local a;if self._state=="Emergency"then a=0.2 elseif self._state=="Cooldown"then a=0.1 else a=0.1 end;local nr,np,ne,nd,nc,nv,ninit=rs<0.9 and(rs<0.7 and 3 or 2)or 1,ps<0.9 and(ps<0.7 and 4 or 3)or 1,(rs<1 or ms<1)and(rs<0.8 or ms<0.8 and 4 or 3)or 1,rs<0.9 and(rs<0.75 and 4 or 3)or 1,p==pr[4]and 3 or p==pr[3]and 2 or 1,(rs<1 or ms<1)and(rs<0.8 or ms<0.8 and 4 or 3)or 1,rs<0.9 and(rs<0.75 and 4 or 3)or 1,rs<0.9 and(rs<0.75 and 4 or 3)or 1;ag.r=ag.r+(nr-ag.r)*a;ag.p=ag.p+(np-ag.p)*a;ag.e=ag.e+(ne-ag.e)*a;ag.d=ag.d+(nd-ag.d)*a;ag.c=ag.c+(nc-ag.c)*a;ag.v=ag.v+(nv-ag.v)*a;ag.init=ag.init+(ninit-ag.init)*a;if self._state=="Normal"then if ag.e>3 or ag.r>3 or ag.d>3 then self._detectedMode="Mode 3 (Visual Load)"elseif ag.p>3 or ag.c>3 then self._detectedMode="Mode 4 (Physics/Scripts)"else self._detectedMode="Mode 5 (Normal Operation)"end end end end;Z._M2={SIM_THRESH=10,PART_THRESH=30,FX_THRESH=3,_scanIndex=1,_scanChildren=nil,SCAN_BATCH_SIZE=8};function Z._M2:f1()local tags={"ManagedRender","ManagedEffect","Clutter","ManagedPhysics"};local function pr(m)local pC,eC,bC=0,0,0;for _,d in ip(m:GetDescendants())do if d:IsA("BasePart")then pC+=1 bC+=d.Size.X*d.Size.Y*d.Size.Z elseif d:IsA("ParticleEmitter")or d:IsA("Light")then eC+=1 end end;if m.PrimaryPart and bC/m.PrimaryPart.Size.X/m.PrimaryPart.Size.Y/m.PrimaryPart.Size.Z>500 and not s2:HasTag(m,tags[3])then s2:AddTag(m,tags[3])end;if pC>self.PART_THRESH and not s2:HasTag(m,tags[1])then s2:AddTag(m,tags[1])end;if eC>self.FX_THRESH and not s2:HasTag(m,tags[2])then s2:AddTag(m,tags[2])end end;if not self._scanChildren then self._scanChildren=s3:GetChildren();self._scanIndex=1 end;local currentScanBatchSize=self.SCAN_BATCH_SIZE;local processedCount=0;while self._scanIndex<=#self._scanChildren and processedCount<currentScanBatchSize do local i=self._scanChildren[self._scanIndex];if i:IsA("Model")and i.PrimaryPart then pr(i)elseif i:IsA("MeshPart")then local k=i.MeshId;if k~=""then Z._M2.s=Z._M2.s or {};Z._M2.s[k]=Z._M2.s[k]or{c=0,i={}};Z._M2.s[k].c+=1;ins(Z._M2.s[k].i,i)end end;self._scanIndex+=1;processedCount+=1 end;if self._scanIndex>#self._scanChildren then local s=Z._M2.s;if s then for _,d in P(s)do if d.c>self.SIM_THRESH then for _,o in ip(d.i)do if not s2:HasTag(o,tags[3])then s2:AddTag(o,tags[3])end end end end end;self._scanChildren=nil;self._scanIndex=1 end end;Z._M4={_tasks={}};function Z._M4:f1(t)local c=cr(function()while true do t.fn(t.args or{})local a=Z._M1.aggr[t.cat]or 1;wt(t.int)end end);ins(self._tasks,c)end;function Z._M4:f2()for _,c in ip(self._tasks)do rs(c)end end;Z._M5={BASE_GRID_SIZE=250,_grid={},_tracked=setmetatable({},{__mode="k"})};function Z._M5:f1(o,d)if not(o and o:IsA("BasePart"))then return end;local currentGridSize=flr(self.BASE_GRID_SIZE*(1+(Z._M1.aggr.r-1)/4));local p=o.Position;local k=flr(p.X/currentGridSize).." "..flr(p.Y/currentGridSize).." "..flr(p.Z/currentGridSize);self._grid[k]=self._grid[k]or{};ins(self._grid[k],o);self._tracked[o]={c=k,d=d}end;function Z._M5:f2(p,r)local res={};local currentGridSize=flr(self.BASE_GRID_SIZE*(1+(Z._M1.aggr.r-1)/4));local cR=flr(r/currentGridSize)+1;local cx,cy,cz=flr(p.X/currentGridSize),flr(p.Y/currentGridSize),flr(p.Z/currentGridSize);for i=cx-cR,cx+cR do for j=cy-cR,cy+cR do for k=cz-cR,cz+cR do local c=self._grid[i.." "..j.." "..k];if c then for _,o in ip(c)do ins(res,o)end end end end end;return res end;Z._M6={DIST_SQR={[1]={4000,10000,25000,inf},[2]={3000,8000,20000,inf},[3]={2000,5000,10000,inf},[4]={1000,3000,5000,inf},[5]={500,1500,2500,inf}},_culled={},_rQ={_h=1,_t=1},_cullQueue={}};function Z._M6:f1(m)if not m.PrimaryPart then return end;local p={};local bS=V();for _,d in ip(m:GetDescendants())do if d:IsA("BasePart")then ins(p,d);bS=bS+d.Size end end;local bSz=m:GetBoundingBox();Z._M5:f1(m.PrimaryPart,{LOD={p=p,m=m,lf=-1,lt=0,isC=false,bS=bSz.Size,lastVisibleTime=clk()}})m.Destroying:Connect(function()Z:removeFromAllCaches(m)end)end;function Z._M6:f2(cf)local a=flr(Z._M1.aggr.r+0.5);local l,cP=clmp(a,1,5),cf.Position;local lSqr=self.DIST_SQR[l];local currentRenderRadius=800*(1+(Z._M1.aggr.r-1)/4);local nby=Z._M5:f2(cP,currentRenderRadius);local d_sq_cull=lSqr[3]*1.2;for _,pP in ip(nby)do local t=Z._M5._tracked[pP];if not(pP and pP.Parent and t and t.d.LOD)then continue end;local ld=t.d.LOD;if ld.isC then continue end;if not Z.U.iV(pP,ld.bS)then ld.lastVisibleTime=clk()end;local dSqr=(pP.Position-cP).MagnitudeSqr;if dSqr>d_sq_cull or clk()-ld.lastVisibleTime>0.1 then ld.isC=true;ins(self._culled,{o=ld.m,p=ld.m.Parent,d=ld});ld.m.Parent=nil;if ld.m.PrimaryPart then ld.m.PrimaryPart:SetNetworkOwner(nil)end;else local nT,nF;if dSqr<lSqr[1]then nT,nF=0,0
elseif dSqr<lSqr[2]then nT,nF=0.25,1
elseif dSqr<lSqr[3]then nT,nF=0.75,2
else nT,nF=1,3 end;
if ld.lt~=nT then local st=clk();local sT=ld.lt or 0;local dur=0.3;sp(function()while clk()-st<dur do local alpha=(clk()-st)/dur;for _,part in ip(ld.p)do part.LocalTransparencyModifier=sT+(nT-sT)*alpha end;wt()end;for _,part in ip(ld.p)do part.LocalTransparencyModifier=nT end end)ld.lt=nT end;if ld.lf~=nF then local rf=Enum.RenderFidelity.FromValue(nF);for _,part in ip(ld.p)do part.RenderFidelity=rf end;ld.lf=nF end end end end;function Z._M6:f3(cf)local a=flr(Z._M1.aggr.r+0.5);local l=clmp(a,1,5);local dSqr=self.DIST_SQR[l][3]*1.2;for i=#self._culled,1,-1 do local cE=self._culled[i];local pP=cE.o.PrimaryPart;if not pP then rem(self._culled,i);continue end;if(pP.Position-cf.Position).MagnitudeSqr<dSqr*0.9 and Z.U.iV(pP,cE.d.bS)then local q=self._rQ;q[q._t]=cE;q._t+=1;rem(self._culled,i)end end end;function Z._M6:f4()local q=self._rQ;local currentMaxProcess=3;while q._h<q._t and currentMaxProcess>0 do local r=q[q._h];q[q._h]=nil;q._h+=1;if r and r.o and r.p then r.o.Parent=r.p;if r.o.PrimaryPart then r.o.PrimaryPart:SetNetworkOwner(s9.LocalPlayer)end;if r.d then r.d.isC=false;r.d.lastVisibleTime=clk();local d=r.d;sp(function()local s,e=1,d.lt or 0;local t=0.3;local st=clk();while clk()-st<t do local alpha=(clk()-st)/t;for _,pt in ip(d.p)do pt.LocalTransparencyModifier=s+(e-s)*alpha end;wt()end;for _,pt in ip(d.p)do pt.LocalTransparencyModifier=e end end)end;end;currentMaxProcess-=1;end;if q._h>10 then q._h=1;q._t=1 end end;Z._M7={DIST_SQR={[1]=inf,[2]=62500,[3]=30000,[4]=6000,[5]=1000},SLEEP_VEL=0.25,_tracked={},_activeInterpolators=setmetatable({},{__mode="k"})};function Z._M7:f1(m)if not m.PrimaryPart then return end;local p={};for _,d in ip(m:GetDescendants())do if d:IsA("BasePart")and not d.Anchored then ins(p,d)end end;if #p>0 then local entry={p=p,lastV={},lastAV={}};Z._M5:f1(m.PrimaryPart,{Physics=entry});self._tracked[m]=entry;m.Destroying:Connect(function()Z:removeFromAllCaches(m)end)end end;function Z._M7:f2(cP)local a=flr(Z._M1.aggr.p+0.5);local l=clmp(a,1,5);local dSqr=self.DIST_SQR[l];local currentPhysicsRadius=500*(1+(Z._M1.aggr.p-1)/4);local nby=Z._M5:f2(cP,currentPhysicsRadius);local processedCount=0;local baseMaxProcess=5;local currentMaxProcess=baseMaxProcess;for _,pP in ip(nby)do if processedCount>=currentMaxProcess then break end;local t=Z._M5._tracked[pP];if not(pP and pP.Parent and t and t.d.Physics)then continue end;local sA=(pP.Position-cP).MagnitudeSqr>dSqr or pP.AssemblyLinearVelocity.Magnitude<self.SLEEP_VEL or s2:HasTag(pP,"ManagedBullet");local entry=t.d.Physics;for _,p in ip(entry.p)do if p and p.Anchored~=sA then p.Anchored=sA;if sA then p:SetNetworkOwner(nil);entry.lastV[p]=p.AssemblyLinearVelocity;entry.lastAV[p]=p.AssemblyAngularVelocity;p.CanCollide=false;p.CanTouch=false;else p.CanCollide=true;p.CanTouch=true;p:SetNetworkOwner(s9.LocalPlayer);if not self._activeInterpolators[p]and entry.lastV[p]and(entry.lastV[p].Magnitude>0.1 or entry.lastAV[p].Magnitude>0.1)then local co=cr(function()local startV,endV=entry.lastV[p],V();local startAV,endAV=entry.lastAV[p],V();local startTime=clk();local duration=0.5;while clk()-startTime<duration do local alpha=(clk()-startTime)/duration;p.AssemblyLinearVelocity=startV:Lerp(endV,alpha);p.AssemblyAngularVelocity=startAV:Lerp(endAV,alpha)wt()end;p.AssemblyLinearVelocity=endV;p.AssemblyLinearVelocity=endV;p.AssemblyAngularVelocity=endAV self._activeInterpolators[p]=nil end);self._activeInterpolators[p]=co;rs(co)end;end end end;processedCount+=1;end end;Z._M8={DIST_CULL={[1]=500,[2]=300,[3]=150,[4]=60,[5]=30},FADE_START_DIST=100,FADE_END_DIST=400,_effects={},_activeEffectInterpolators={}};function Z._M8:f1(i)local aP=i:IsA("BasePart")and i or i:FindFirstAncestorWhichIsA("Model")and i:FindFirstAncestorWhichIsA("Model").PrimaryPart;local function pE(e)local d={e=e,a=aP,o={}};if e:IsA("ParticleEmitter")then d.o.Rate=e.Rate elseif e:IsA("PointLight")or e:IsA("SpotLight")or e:IsA("SurfaceLight")then d.o.Brightness=e.Brightness;d.o.Enabled=e.Enabled elseif e:IsA("Beam")then d.o.Width0=e.Width0;d.o.Width1=e.Width1 elseif e:IsA("Trail")then d.o.Lifetime=e.Lifetime elseif e:IsA("Highlight")then d.o.Enabled=e.Enabled elseif e:IsA("PostEffect")or e:IsA("BloomEffect")or e:IsA("ColorCorrectionEffect")or e:IsA("DepthOfFieldEffect")or e:IsA("SunRaysEffect")or e:IsA("BlurEffect")or e:IsA("Atmosphere")or e:IsA("Clouds")then d.o.Enabled=e.Enabled;if e:IsA("Atmosphere")then d.o.Density=e.Density elseif e:IsA("Clouds")then d.o.Cover=e.Cover elseif e:IsA("BloomEffect")then d.o.Intensity=e.Intensity elseif e:IsA("ColorCorrectionEffect")then d.o.Saturation=e.Saturation elseif e:IsA("SunRaysEffect")then d.o.Intensity=e.Intensity elseif e:IsA("BlurEffect")then d.o.Size=e.Size end end;ins(self._effects,d)e.Destroying:Connect(function()Z:removeFromAllCaches(e)end)end;if i:IsA("ParticleEmitter")or i:IsA("Beam")or i:IsA("Trail")or i:IsA("PointLight")or i:IsA("SpotLight")or i:IsA("SurfaceLight")or i:IsA("Highlight")or i:IsA("PostEffect")or i:IsA("BloomEffect")or i:IsA("ColorCorrectionEffect")or i:IsA("DepthOfFieldEffect")or i:IsA("SunRaysEffect")or i:IsA("BlurEffect")or i:IsA("Atmosphere")or i:IsA("Clouds")then pE(i)else for _,d in ip(i:GetDescendants())do if d:IsA("ParticleEmitter")or d:IsA("Beam")or d:IsA("Trail")or d:IsA("PointLight")or d:IsA("SpotLight")or d:IsA("SurfaceLight")or d:IsA("Highlight")or d:IsA("PostEffect")or d:IsA("BloomEffect")or d:IsA("ColorCorrectionEffect")or d:IsA("DepthOfFieldEffect")or d:IsA("SunRaysEffect")or d:IsA("BlurEffect")or d:IsA("Atmosphere")or d:IsA("Clouds")then pE(d)end end end end;function Z._M8:f2(effect,property,startValue,endValue,duration)if self._activeEffectInterpolators[effect]then if rs(self._activeEffectInterpolators[effect],"yield")then self._activeEffectInterpolators[effect]=nil end end;local co=cr(function()local startTime=clk();while clk()-startTime<duration do local alpha=(clk()-startTime)/duration;effect[property]=startValue+(endValue-startValue)*alpha wt()end;effect[property]=endValue self._activeEffectInterpolators[effect]=nil end)self._activeEffectInterpolators[effect]=co;rs(co)end;function Z._M8:f3(cf)local a=flr(Z._M1.aggr.e+0.5);local l=clmp(a,1,5);local cD_sq=self.DIST_CULL[l]*self.DIST_CULL[l];local cP=cf.Position;local aggrV=Z._M1.aggr.v;for _,d in ip(self._effects)do local e,aP=d.e,d.a;if not e or not e.Parent then return end;local isGlobalEffect=e:IsA("PostEffect")or e:IsA("BloomEffect")or e:IsA("ColorCorrectionEffect")or e:IsA("DepthOfFieldEffect")or e:IsA("SunRaysEffect")or e:IsA("BlurEffect")or e:IsA("Atmosphere")or e:IsA("Clouds");if isGlobalEffect then local targetEnabled=(aggrV<4);local targetValue;if e:IsA("Atmosphere")then targetEnabled=(aggrV<5);targetValue=d.o.Density*(1-(aggrV-1)/4)if e.Density~=targetValue then self:f2(e,"Density",e.Density,targetValue,0.5)end elseif e:IsA("Clouds")then targetEnabled=(aggrV<5);targetValue=d.o.Cover*(1-(aggrV-1)/4)if e.Cover~=targetValue then self:f2(e,"Cover",e.Cover,targetValue,0.5)end elseif e:IsA("BloomEffect")then targetEnabled=(aggrV<4);targetValue=d.o.Intensity*(1-(aggrV-1)/3)if e.Intensity~=targetValue then self:f2(e,"Intensity",e.Intensity,targetValue,0.5)end elseif e:IsA("ColorCorrectionEffect")then targetEnabled=(aggrV<4);targetValue=d.o.Saturation*(1-(aggrV-1)/3)if e.Saturation~=targetValue then self:f2(e,"Saturation",e.Saturation,targetValue,0.5)end elseif e:IsA("SunRaysEffect")then targetEnabled=(aggrV<4);targetValue=d.o.Intensity*(1-(aggrV-1)/3)if e.Intensity~=targetValue then self:f2(e,"Intensity",e.Intensity,targetValue,0.5)end elseif e:IsA("BlurEffect")then targetEnabled=(aggrV<4)and d.o.Enabled;targetValue=d.o.Size*(1-(aggrV-1)/3)if e.Size~=targetValue then self:f2(e,"Size",e.Size,targetValue,0.5)end end;if e.Enabled~=targetEnabled then e.Enabled=targetEnabled end;else if not aP or not aP.Parent then return end;local dSqr_effect=(aP.Position-cP).MagnitudeSqr;local targetEnabled=Z.U.iV(aP,aP.Size)and dSqr_effect<cD_sq;local fadeFactor=1;local FADE_START_DSQR=self.FADE_START_DIST*self.FADE_START_DIST;local FADE_END_DSQR=self.FADE_END_DIST*self.FADE_END_DIST;if dSqr_effect>FADE_START_DSQR then fadeFactor=1-clmp((dSqr_effect-FADE_START_DSQR)/(FADE_END_DSQR-FADE_END_DSQR),0,1)end;if e:IsA("ParticleEmitter")then e.Rate=d.o.Rate*fadeFactor elseif e:IsA("Light")then e.Brightness=d.o.Brightness*fadeFactor;e.Enabled=(targetEnabled and fadeFactor>0.01)elseif e:IsA("Beam")then e.Width0=d.o.Width0*fadeFactor;e.Width1=d.o.Width1*fadeFactor elseif e:IsA("Trail")then e.Lifetime=d.o.Lifetime*fadeFactor elseif e:IsA("Highlight")then e.Enabled=(targetEnabled and fadeFactor>0.01)end end;end)end end;Z._M9={CULL_PCNT={[1]=0,[2]=0.35,[3]=0.6,[4]=0.75,[5]=0.9},DIST_START=250,_culled={},_clutter={}, _cullQueue={}, _unCullQueue={}};function Z._M9:f1(i)local pP=i:IsA("Model")and i.PrimaryPart or(i:IsA("BasePart")and i);if pP then ins(self._clutter,{i=i,pP=pP,isC=false,lastVisibleTime=clk()})i.Destroying:Connect(function()Z:removeFromAllCaches(i)end)end;end;function Z._M9:f2(cP)local a=flr(Z._M1.aggr.d+0.5);local l=clmp(a,1,5);local cPcnt=self.CULL_PCNT[l];if cPcnt==0 then self:f4()return end;local currentDistStart=250*(1+(Z._M1.aggr.d-1)/4);local processedCount=0;local baseMaxProcess=3;local currentMaxProcess=baseMaxProcess;local pTC={};for _,cD in ip(self._clutter)do if not cD.isC and(cD.pP.Position-cP).Magnitude>currentDistStart and clk()-cD.lastVisibleTime>0.5 then ins(pTC,cD)end end;for i=1,flr(#pTC*cPcnt)do if processedCount>=currentMaxProcess then break end;local cD=pTC[i];if not cD.isC then cD.isC=true;ins(self._culled,{o=cD.i,p=cD.i.Parent,d=cD});cD.i.Parent=nil;if cD.pP then cD.pP:SetNetworkOwner(nil)end;end;processedCount+=1;end;function Z._M9:f3(cP)local a=flr(Z._M1.aggr.d+0.5);local l=clmp(a,1,5);local currentDistStart=250*(1+(Z._M1.aggr.d-1)/4);local baseMaxProcess=3;local currentMaxProcess=baseMaxProcess;local processedCount=0;for i=#self._culled,1,-1 do if processedCount>=currentMaxProcess then break end;local e=self._culled[i];if not e.o or not e.o.PrimaryPart then rem(self._culled,i);continue end;if(e.d.pP.Position-cP).Magnitude<currentDistStart*0.9 then local q=self._unCullQueue;q[#q+1]=e;rem(self._culled,i)end;processedCount+=1;end end;function Z._M9:f4()local q=self._unCullQueue;if #q>0 then local currentMaxProcess=3;while #q>0 and currentMaxProcess>0 do local e=rem(q,1);if e and e.o and e.p then e.d.isC=false;e.d.lastVisibleTime=clk();e.o.Parent=e.p;if e.d.pP then e.d.pP:SetNetworkOwner(s9.LocalPlayer)end;end;currentMaxProcess-=1;end end;end;Z._M11={_denseAreas={}};function Z._M11:f1(cf)local currentGridSize=flr(Z._M5.BASE_GRID_SIZE*(1+(Z._M1.aggr.r-1)/4));local cP=cf.Position;self._denseAreas={};local processedCount=0;local baseMaxProcess=5;local currentMaxProcess=baseMaxProcess;local nby=Z._M5:f2(cP,1000);for _,pP in ip(nby)do if processedCount>=currentMaxProcess then break end;local t=Z._M5._tracked[pP];if t then local k=t.c;local count=0;if Z._M5._grid[k]then count=#Z._M5._grid[k]end;if count>10 then self._denseAreas[k]=true end end;processedCount+=1;end end;Z._M11:f2=function(cf,pP)local currentGridSize=flr(Z._M5.BASE_GRID_SIZE*(1+(Z._M1.aggr.r-1)/4));local cP=cf.Position;local k=flr(pP.Position.X/currentGridSize).." "..flr(pP.Position.Y/currentGridSize).." "..flr(pP.Position.Z/currentGridSize);return Z._M11._denseAreas[k]end;Z._memoryManager={_lastGCStep=0,_gcStepsPerFrame=1,MEM_THRESHOLD=400, _mem_usage=0};function Z._memoryManager:checkMemory()self._mem_usage=collectgarbage("count")end;function Z._memoryManager:gcStep()local fps=Z._M1._avgFps;if fps<Z._M1.EMG_FPS+5 then return end;local step_size=50;if self._mem_usage>self.MEM_THRESHOLD then step_size=200 end;local success, message=collectgarbage("step",step_size);end;Z._newInstancesQueue={};function Z:processNewInstancesQueue()local baseBatchSize=2;local currentScanBatchSize=baseBatchSize;local processedCount=0;while #self._newInstancesQueue > 0 and processedCount < currentScanBatchSize do local i=rem(self._newInstancesQueue,1);if not i then continue end;if s2:HasTag(i,"ManagedRender")then Z._M6:f1(i)end;if s2:HasTag(i,"ManagedPhysics")then Z._M7:f1(i)end;if s2:HasTag(i,"ManagedEffect")then Z._M8:f1(i)end;if s2:HasTag(i,"Clutter")then Z._M9:f1(i)end;Z._M13.f1(Z._M13,i);Z._M12.f1(Z._M12,i);processedCount+=1 end end;Z._M14={_cacheList={},_currentCacheIndex=1,_currentEntryIndex=1,CLEAN_BATCH_SIZE=5,_compactThreshold=50};Z._M14._cacheList={Z._M6._culled,Z._M8._effects,Z._M9._culled,Z._M9._clutter,Z._M13._trackedScripts,Z._M5._tracked,Z._M7._tracked};function Z:removeFromAllCaches(instance)for i=1,#self._M14._cacheList do local cache=self._M14._cacheList[i];for j=#cache,1,-1 do local entry=cache[j];local instanceToCheck;if i==1 then instanceToCheck=entry.o elseif i==2 then instanceToCheck=entry.e elseif i==3 then instanceToCheck=entry.o elseif i==4 then instanceToCheck=entry.i elseif i==5 then instanceToCheck=entry elseif i==6 then instanceToCheck=entry.instance elseif i==7 then instanceToCheck=entry.i end;if not instanceToCheck or not instanceToCheck.Parent or not instanceToCheck:IsDescendantOf(game)then rem(cache,j)end end end;end;function Z._M14:f1()local currentCache=self._M14._cacheList[self._M14._currentCacheIndex];if not currentCache then return end;local currentCleanBatchSize=self.CLEAN_BATCH_SIZE;local processedCount=0;local markedForRemovalCount=0;local initialEntryIndex=self._M14._currentEntryIndex;for i=initialEntryIndex,#currentCache do if processedCount>=currentCleanBatchSize then break end;local entry=currentCache[i];local instanceToCheck=nil;if self._M14._currentCacheIndex==1 then instanceToCheck=entry.o elseif self._M14._currentCacheIndex==2 then instanceToCheck=entry.e elseif self._M14._currentCacheIndex==3 then instanceToCheck=entry.o elseif self._M14._currentCacheIndex==4 then instanceToCheck=entry.i elseif self._M14._currentCacheIndex==5 then instanceToCheck=entry elseif self._M14._currentCacheIndex==6 then instanceToCheck=entry.instance elseif self._M14._currentCacheIndex==7 then instanceToCheck=entry.i end;if not instanceToCheck or not instanceToCheck.Parent or not instanceToCheck:IsDescendantOf(game)then currentCache[i]=nil;markedForRemovalCount+=1 end;processedCount+=1;self._M14._currentEntryIndex=i+1 end;if markedForRemovalCount>0 and (markedForRemovalCount>=self._compactThreshold or self._M14._currentEntryIndex>#currentCache)then local newCache={};local newIndex=1;for _,entry in ip(currentCache)do if entry~=nil then newCache[newIndex]=entry;newIndex+=1 end end;for k,v in P(currentCache)do currentCache[k]=nil end;for i=1,newIndex-1 do currentCache[i]=newCache[i]end;self._M14._currentEntryIndex=1;end;if self._M14._currentEntryIndex>#currentCache or #currentCache==0 then self._M14._currentCacheIndex=self._M14._currentCacheIndex+1;self._M14._currentEntryIndex=1;if self._M14._currentCacheIndex>#self._M14._cacheList then self._M14._currentCacheIndex=1 end end end;Z._clientInterpolator={_trackedObjects=setmetatable({},{__mode="k"})};function Z._clientInterpolator:track(instance)if not instance or self._trackedObjects[instance]then return end;self._trackedObjects[instance]={instance=instance,serverCF=instance.CFrame,clientCF=instance.CFrame,lastUpdate=clk()};instance:GetPropertyChangedSignal("CFrame"):Connect(function()self._trackedObjects[instance].serverCF=instance.CFrame;self._trackedObjects[instance].lastUpdate=clk()end);instance.AncestryChanged:Connect(function()if not instance:IsDescendantOf(game)then self._trackedObjects[instance]=nil end end)end;function Z._clientInterpolator:update()local cTime=clk();local currentAggrP=Z._M1.aggr.p;local minDuration=0.05;local maxDuration=0.2;local dynamicDuration=mn(maxDuration,mx(minDuration,maxDuration-currentAggrP*0.03));for instance,data in P(self._trackedObjects)do if not instance or not instance.Parent then self._trackedObjects[instance]=nil;continue end;local sCF,lCF=data.serverCF,data.clientCF;local alpha=clmp((cTime-data.lastUpdate)/dynamicDuration,0,1);instance.CFrame=lCF:Lerp(sCF,alpha);data.clientCF=instance.CFrame end end;Z._M13={_trackedScripts={},_maxScripts=5};function Z._M13:f1(script)if not script:IsA("Script")or script.Parent:IsA("LocalScript")then return end;ins(self._trackedScripts,script)end;function Z._M13:f2(cP)local aggrV=Z._M1.aggr.v;for _,script in ip(self._trackedScripts)do if not script or not script.Parent then continue end;local dSqr=(script.Parent.Position-cP).MagnitudeSqr;if dSqr>10000 and aggrV>3 then script.Enabled=false else script.Enabled=true end end end;Z._M12={_effects={},_activeInterpolators=setmetatable({},{__mode="k"}),DIST_SQR={100000,250000,500000,inf}};function Z._M12:f1(i)local pP=i:IsA("BasePart")and i or i:FindFirstAncestorWhichIsA("Model")and i:FindFirstAncestorWhichIsA("Model").PrimaryPart;local function pE(e)local d={e=e,pP=pP,o={}};if e:IsA("ParticleEmitter")then d.o.Rate=e.Rate elseif e:IsA("PointLight")or e:IsA("SpotLight")or e:IsA("SurfaceLight")then d.o.Brightness=e.Brightness elseif e:IsA("Beam")then d.o.Width0=e.Width0;d.o.Width1=e.Width1 elseif e:IsA("Trail")then d.o.Lifetime=e.Lifetime elseif e:IsA("Highlight")then d.o.FillTransparency=e.FillTransparency end;ins(self._effects,d)e.Destroying:Connect(function()Z:removeFromAllCaches(e)end)end;if i:IsA("ParticleEmitter")or i:IsA("Beam")or i:IsA("Trail")or i:IsA("PointLight")or i:IsA("SpotLight")or i:IsA("SurfaceLight")or i:IsA("Highlight")then pE(i)else for _,d in ip(i:GetDescendants())do if d:IsA("ParticleEmitter")or d:IsA("Beam")or d:IsA("Trail")or d:IsA("PointLight")or d:IsA("SpotLight")or d:IsA("SurfaceLight")or d:IsA("Highlight")then pE(d)end end end end;function Z._M12:f2(cf)local a=flr(Z._M1.aggr.e+0.5);local l=clmp(a,1,4);local lSqr=self.DIST_SQR[l];local cP=cf.Position;for _,d in ip(self._effects)do local e,pP=d.e,d.pP;if not e or not pP or not e.Parent or not pP.Parent then return end;local dSqr=(pP.Position-cP).MagnitudeSqr;if dSqr>lSqr then local dV=0;local dur=0.5;if e:IsA("ParticleEmitter")then if e.Rate~=dV then self.f3(self,e,"Rate",e.Rate,dV,dur)end elseif e:IsA("Light")then if e.Brightness~=dV then self.f3(self,e,"Brightness",e.Brightness,dV,dur)end elseif e:IsA("Beam")then if e.Width0~=dV or e.Width1~=dV then self.f3(self,e,"Width0",e.Width0,dV,dur);self.f3(self,e,"Width1",e.Width1,dV,dur)end elseif e:IsA("Trail")then if e.Lifetime~=dV then self.f3(self,e,"Lifetime",e.Lifetime,dV,dur)end elseif e:IsA("Highlight")then if e.FillTransparency~=1 then self.f3(self,e,"FillTransparency",e.FillTransparency,1,dur)end end else local dV_orig;local dur=0.5;if e:IsA("ParticleEmitter")then dV_orig=d.o.Rate if e.Rate~=dV_orig then self.f3(self,e,"Rate",e.Rate,dV_orig,dur)end elseif e:IsA("Light")then dV_orig=d.o.Brightness if e.Brightness~=dV_orig then self.f3(self,e,"Brightness",e.Brightness,dV_orig,dur)end elseif e:IsA("Beam")then local w0,w1=d.o.Width0,d.o.Width1 if e.Width0~=w0 or e.Width1~=w1 then self.f3(self,e,"Width0",e.Width0,w0,dur);self.f3(self,e,"Width1",e.Width1,w1,dur)end elseif e:IsA("Trail")then dV_orig=d.o.Lifetime if e.Lifetime~=dV_orig then self.f3(self,e,"Lifetime",e.Lifetime,dV_orig,dur)end elseif e:IsA("Highlight")then dV_orig=d.o.FillTransparency if e.FillTransparency~=dV_orig then self.f3(self,e,"FillTransparency",e.FillTransparency,dV_orig,dur)end end end end end end;function Z._M12:f3(effect,property,startValue,endValue,duration)if self._activeInterpolators[effect]then if rs(self._activeInterpolators[effect],"yield")then self._activeInterpolators[effect]=nil end end;local co=cr(function()local startTime=clk();while clk()-startTime<duration do local alpha=(clk()-startTime)/duration;effect[property]=startValue+(endValue-startValue)*alpha wt()end;effect[property]=endValue self._activeInterpolators[effect]=nil end)self._activeInterpolators[effect]=co;rs(co)end;Z:Activate=function()local tags={"ManagedRender","ManagedPhysics","ManagedEffect","Clutter","ManagedScriptActivity","ManagedBullet"};for _,t in ip(tags)do for _,i in ip(s2:GetTagged(t))do Z._newInstancesQueue[#Z._newInstancesQueue+1]=i end;s2:GetInstanceAddedSignal(t):Connect(function(i)Z._newInstancesQueue[#Z._newInstancesQueue+1]=i end)end;local lighting=G:GetService("Lighting");local function trackLightingEffects(child)if child:IsA("Atmosphere")or child:IsA("Clouds")or child:IsA("PostEffect")or child:IsA("BloomEffect")or child:IsA("ColorCorrectionEffect")or child:IsA("DepthOfFieldEffect")or child:IsA("SunRaysEffect")or child:IsA("BlurEffect")or child:IsA("Atmosphere")or child:IsA("Clouds")then Z._M8.f1(Z._M8,child)end end;for _,child in ipairs(lighting:GetChildren())do trackLightingEffects(child)end;lighting.ChildAdded:Connect(trackLightingEffects);s10.PlayerAdded:Connect(function(player)if player==s10.LocalPlayer then return end;player.CharacterAdded:Connect(function(character)Z._clientInterpolator.track(Z._clientInterpolator,character:FindFirstChild("HumanoidRootPart"))end)end)for _,player in ipairs(s10.GetPlayers())do if player~=s10.LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart")then Z._clientInterpolator.track(Z._clientInterpolator,player.Character:FindFirstChild("HumanoidRootPart"))end end;task.delay(1.5,function()Z._isReady=true end);Z._M4:f1({fn=function()Z._M1.f2(Z._M1,s1.Heartbeat:Wait())end,int=0,cat="c"});Z._M4:f1({fn=function()if not Z._isReady then return end;local cf=cam.CFrame;Z._M6.f2(Z._M6,cf);Z._M7.f2(Z._M7,cf.Position);Z._M8.f3(Z._M8,cf);Z._M9.f2(Z._M9,cf.Position);Z._M11.f1(Z._M11,cf);Z._M13.f2(Z._M13,cf.Position);Z._M12.f2(Z._M12,cf);Z._clientInterpolator.update(Z._clientInterpolator);end,int=0.12,cat="c"});Z._M4:f1({fn=function()if not Z._isReady then return end;local cf=cam.CFrame;Z._M6.f3(Z._M6,cf);Z._M9.f3(Z._M9,cf.Position)end,int=0.1,cat="r"});Z._M4:f1({fn=function()if not Z._isReady then return end;Z._M6.f4(Z._M6);Z._M9.f4(Z._M9)end,int=0.1,cat="r"});Z._M4:f1({fn=function()Z.processNewInstancesQueue(Z)end,int=0.01,cat="init"});Z._M4:f1({fn=function()Z._M14.f1(Z._M14)end,int=0.5,cat="init"});Z._M4:f1({fn=function()Z._memoryManager.checkMemory(Z._memoryManager)end,int=5,cat="c"});Z._M4:f1({fn=function()Z._memoryManager.gcStep(Z._memoryManager)end,int=0.01,cat="c"});Z._M4:f2()end;Z:Activate()
